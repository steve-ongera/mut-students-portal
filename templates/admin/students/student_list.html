{% extends 'admin/admin_base.html' %}
{% load static %}

{% block title %}Student Management{% endblock %}

{% block page_title %}Student Management{% endblock %}
{% block page_subtitle %}Manage student records, view details, and perform actions{% endblock %}

{% block content %}
<div class="content-card">
    <!-- Header with Actions -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h5 class="card-title mb-0">All Students</h5>
            <p class="text-muted mb-0">{{ total_students }} student(s) found</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#filterModal">
                <i class="ri-filter-line me-1"></i> Filter
            </button>
            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#bulkActionModal">
                <i class="ri-group-line me-1"></i> Bulk Actions
            </button>
            <a href="{% url 'add_student' %}" class="btn btn-sm btn-primary">
                <i class="ri-user-add-line me-1"></i> Add Student
            </a>
            <a href="{% url 'export_students' %}" class="btn btn-sm btn-success">
                <i class="ri-download-line me-1"></i> Export
            </a>
        </div>
    </div>

    <!-- Search Bar -->
    <form method="get" class="mb-4">
        <div class="input-group">
            <input type="text" class="form-control" name="search" placeholder="Search by registration number, name, email, or national ID..." value="{{ search_query }}">
            <button class="btn btn-primary" type="submit">
                <i class="ri-search-line"></i> Search
            </button>
        </div>
    </form>

    <!-- Students Table -->
    <div class="table-responsive">
        <table class="table datatable" id="studentsTable">
            <thead>
                <tr>
                    <th width="50">
                        <input type="checkbox" id="selectAll" class="form-check-input">
                    </th>
                    <th>Registration No.</th>
                    <th>Full Name</th>
                    <th>Programme</th>
                    <th>Year</th>
                    <th>Semester</th>
                    <th>Status</th>
                    <th>GPA</th>
                    <th width="250">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr>
                    <td>
                        <input type="checkbox" name="student_ids" value="{{ student.id }}" class="form-check-input student-checkbox">
                    </td>
                    <td>
                        <strong class="text-primary">{{ student.registration_number }}</strong>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar-xs me-2">
                                <img src="{% if student.user.profile_picture %}{{ student.user.profile_picture.url }}{% else %}{% static 'avatar2.png' %}{% endif %}" 
                                     alt="{{ student.user.get_full_name }}" class="rounded-circle">
                            </div>
                            <div>
                                <p class="mb-0 fw-medium">{{ student.user.get_full_name }}</p>
                                <small class="text-muted">{{ student.user.email }}</small>
                            </div>
                        </div>
                    </td>
                    <td>{{ student.programme.code }}</td>
                    <td>
                        <span class="badge bg-info rounded-pill">Year {{ student.current_year }}</span>
                    </td>
                    <td>
                        <span class="badge bg-secondary rounded-pill">Sem {{ student.current_semester }}</span>
                    </td>
                    <td>
                        {% if student.student_status == 'active' %}
                        <span class="badge bg-success rounded-pill">Active</span>
                        {% elif student.student_status == 'suspended' %}
                        <span class="badge bg-danger rounded-pill">Suspended</span>
                        {% elif student.student_status == 'deferred' %}
                        <span class="badge bg-warning rounded-pill">Deferred</span>
                        {% elif student.student_status == 'graduated' %}
                        <span class="badge bg-primary rounded-pill">Graduated</span>
                        {% else %}
                        <span class="badge bg-secondary rounded-pill">{{ student.get_student_status_display }}</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="fw-bold {% if student.cumulative_gpa >= 3.0 %}text-success{% elif student.cumulative_gpa >= 2.0 %}text-warning{% else %}text-danger{% endif %}">
                            {{ student.cumulative_gpa }}
                        </span>
                    </td>
                    <td>
                        <div class="d-flex gap-1">
                            {% if student.registration_number %}
                                <a href="{% url 'student_detail' student.registration_number %}" 
                                   class="btn btn-sm btn-outline-primary" 
                                   title="View Details">
                                    <i class="ri-eye-line"></i>
                                </a>
                                
                                <a href="{% url 'student_performance' student.registration_number %}" 
                                   class="btn btn-sm btn-outline-info" 
                                   title="Performance">
                                    <i class="ri-bar-chart-line"></i>
                                </a>
                                
                                <a href="{% url 'student_fees' student.registration_number %}" 
                                   class="btn btn-sm btn-outline-success" 
                                   title="Fees">
                                    <i class="ri-money-dollar-circle-line"></i>
                                </a>
                                
                                <a href="{% url 'update_student' student.registration_number %}" 
                                   class="btn btn-sm btn-outline-warning" 
                                   title="Update">
                                    <i class="ri-edit-line"></i>
                                </a>
                                
                                <a href="{% url 'delete_student' student.registration_number %}" 
                                   class="btn btn-sm btn-outline-danger" 
                                   title="Delete"
                                   onclick="return confirm('Are you sure you want to delete this student?')">
                                    <i class="ri-delete-bin-line"></i>
                                </a>
                            {% else %}
                                <span class="text-muted small">No actions</span>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" class="text-center py-5">
                        <div class="text-muted">
                            <i class="ri-user-search-line display-4"></i>
                            <p class="mt-3">No students found</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if students.has_other_pages %}
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if students.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ students.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if programme_filter %}&programme={{ programme_filter }}{% endif %}{% if year_filter %}&year={{ year_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                    <i class="ri-arrow-left-line"></i>
                </a>
            </li>
            {% endif %}
            
            {% for i in students.paginator.page_range %}
                {% if students.number == i %}
                <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                {% else %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ i }}{% if search_query %}&search={{ search_query }}{% endif %}{% if programme_filter %}&programme={{ programme_filter }}{% endif %}{% if year_filter %}&year={{ year_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">{{ i }}</a>
                </li>
                {% endif %}
            {% endfor %}
            
            {% if students.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ students.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if programme_filter %}&programme={{ programme_filter }}{% endif %}{% if year_filter %}&year={{ year_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                    <i class="ri-arrow-right-line"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="get">
                <div class="modal-header">
                    <h5 class="modal-title">Filter Students</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Programme</label>
                        <select name="programme" class="form-select">
                            <option value="">All Programmes</option>
                            {% for programme in programmes %}
                            <option value="{{ programme.id }}" {% if programme_filter == programme.id|stringformat:"i" %}selected{% endif %}>
                                {{ programme.code }} - {{ programme.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Year of Study</label>
                        <select name="year" class="form-select">
                            <option value="">All Years</option>
                            {% for year in years %}
                            <option value="{{ year }}" {% if year_filter == year|stringformat:"i" %}selected{% endif %}>
                                Year {{ year }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select name="status" class="form-select">
                            <option value="">All Statuses</option>
                            {% for status_code, status_name in status_choices %}
                            <option value="{{ status_code }}" {% if status_filter == status_code %}selected{% endif %}>
                                {{ status_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="{% url 'student_list' %}" class="btn btn-outline-secondary">Clear Filters</a>
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Action Modal -->
<div class="modal fade" id="bulkActionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'bulk_update_students' %}" id="bulkActionForm">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Bulk Actions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select Action</label>
                        <select name="action" class="form-select" id="bulkActionSelect" required>
                            <option value="">Choose action...</option>
                            <option value="update_status">Update Status</option>
                            <option value="update_year">Update Year</option>
                            <option value="update_semester">Update Semester</option>
                        </select>
                    </div>
                    
                    <div id="actionFields" style="display: none;">
                        <!-- Status Field -->
                        <div class="mb-3" id="statusField" style="display: none;">
                            <label class="form-label">New Status</label>
                            <select name="status_value" class="form-select">
                                {% for status_code, status_name in status_choices %}
                                <option value="{{ status_code }}">{{ status_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Year Field -->
                        <div class="mb-3" id="yearField" style="display: none;">
                            <label class="form-label">New Year</label>
                            <select name="year_value" class="form-select">
                                {% for i in "1234567" %}
                                <option value="{{ i }}">Year {{ i }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Semester Field -->
                        <div class="mb-3" id="semesterField" style="display: none;">
                            <label class="form-label">New Semester</label>
                            <select name="semester_value" class="form-select">
                                {% for semester_code, semester_name in semester_choices %}
                                <option value="{{ semester_code }}">{{ semester_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <i class="ri-information-line me-2"></i>
                        This action will affect <span id="selectedCount">0</span> selected student(s).
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="bulkActionBtn" disabled>Apply Action</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .avatar-xs {
        width: 32px;
        height: 32px;
    }
    
    .avatar-xs img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .student-checkbox:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    #selectAll:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    /* Action button styles */
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    .btn-sm i {
        font-size: 1rem;
    }
    
    /* Smooth hover effect for action buttons */
    .btn-sm:hover {
        transform: translateY(-2px);
        transition: transform 0.2s ease;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize DataTable
    if ($.fn.DataTable && !$.fn.DataTable.isDataTable('#studentsTable')) {
        $('#studentsTable').DataTable({
            ordering: true,
            searching: false,
            paging: false,
            info: false,
            responsive: true,
            autoWidth: false,
            columnDefs: [
                { orderable: false, targets: [0, 8] }
            ]
        });
    }
    
    // Select all functionality
    const selectAll = document.getElementById('selectAll');
    const studentCheckboxes = document.querySelectorAll('.student-checkbox');
    
    if (selectAll) {
        selectAll.addEventListener('change', function() {
            studentCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateSelectedCount();
        });
    }
    
    // Update selected count
    function updateSelectedCount() {
        const selectedCount = document.querySelectorAll('.student-checkbox:checked').length;
        const countSpan = document.getElementById('selectedCount');
        const bulkBtn = document.getElementById('bulkActionBtn');
        
        if (countSpan) countSpan.textContent = selectedCount;
        if (bulkBtn) bulkBtn.disabled = selectedCount === 0;
    }
    
    studentCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });
    
    // Bulk action field visibility
    const bulkActionSelect = document.getElementById('bulkActionSelect');
    const actionFields = document.getElementById('actionFields');
    const statusField = document.getElementById('statusField');
    const yearField = document.getElementById('yearField');
    const semesterField = document.getElementById('semesterField');
    
    if (bulkActionSelect) {
        bulkActionSelect.addEventListener('change', function() {
            const action = this.value;
            
            // Hide all fields first
            if (actionFields) actionFields.style.display = 'none';
            if (statusField) statusField.style.display = 'none';
            if (yearField) yearField.style.display = 'none';
            if (semesterField) semesterField.style.display = 'none';
            
            // Disable all select fields
            const statusSelect = statusField?.querySelector('select');
            const yearSelect = yearField?.querySelector('select');
            const semesterSelect = semesterField?.querySelector('select');
            
            if (statusSelect) statusSelect.disabled = true;
            if (yearSelect) yearSelect.disabled = true;
            if (semesterSelect) semesterSelect.disabled = true;
            
            // Show and enable the appropriate field
            if (action && actionFields) {
                actionFields.style.display = 'block';
                
                if (action === 'update_status' && statusField) {
                    statusField.style.display = 'block';
                    if (statusSelect) statusSelect.disabled = false;
                } else if (action === 'update_year' && yearField) {
                    yearField.style.display = 'block';
                    if (yearSelect) yearSelect.disabled = false;
                } else if (action === 'update_semester' && semesterField) {
                    semesterField.style.display = 'block';
                    if (semesterSelect) semesterSelect.disabled = false;
                }
            }
        });
    }
    
    // Handle bulk action form submission
    const bulkActionForm = document.getElementById('bulkActionForm');
    if (bulkActionForm) {
        bulkActionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const selectedCheckboxes = document.querySelectorAll('.student-checkbox:checked');
            const selectedCount = selectedCheckboxes.length;
            
            if (selectedCount === 0) {
                if (typeof toastr !== 'undefined') {
                    toastr.error('Please select at least one student.');
                } else {
                    alert('Please select at least one student.');
                }
                return false;
            }
            
            const action = document.getElementById('bulkActionSelect').value;
            if (!action) {
                if (typeof toastr !== 'undefined') {
                    toastr.error('Please select an action.');
                } else {
                    alert('Please select an action.');
                }
                return false;
            }
            
            // Collect selected student IDs
            const studentIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            
            // Create a hidden input for student IDs
            let hiddenInput = this.querySelector('input[name="student_ids"]');
            if (!hiddenInput) {
                hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'student_ids';
                this.appendChild(hiddenInput);
            }
            hiddenInput.value = studentIds.join(',');
            
            // Get the appropriate value based on action
            let newValue = '';
            if (action === 'update_status') {
                const statusSelect = document.querySelector('#statusField select');
                newValue = statusSelect ? statusSelect.value : '';
            } else if (action === 'update_year') {
                const yearSelect = document.querySelector('#yearField select');
                newValue = yearSelect ? yearSelect.value : '';
            } else if (action === 'update_semester') {
                const semesterSelect = document.querySelector('#semesterField select');
                newValue = semesterSelect ? semesterSelect.value : '';
            }
            
            // Create or update hidden input for new_value
            let valueInput = this.querySelector('input[name="new_value"]');
            if (!valueInput) {
                valueInput = document.createElement('input');
                valueInput.type = 'hidden';
                valueInput.name = 'new_value';
                this.appendChild(valueInput);
            }
            valueInput.value = newValue;
            
            // Submit the form
            this.submit();
        });
    }
});
</script>
{% endblock %}